# Configurable AMALTHEA PREM IP

This IP is used with the [AMALTHEA](https://projects.eclipse.org/projects/automotive.app4mc/downloads) design flow to mimic the behavior of a generic hardware accelerator.

This IP is called PREM because it obbeys the [Pretictable Execution Model](https://www.ideals.illinois.edu/bitstream/handle/2142/16605/PREMtechrep.pdf), i.e., it performs read, execution, write operations in that order.

Different from the [AMALTHEA PREM IP](../prem/readme.md), where the designer needs to change constants in design time to set the behavior of the IP, the *Configurable AMALTHEA PREM IP* allows to change this configuration in runtime, in the FRED software. Check the software example located in *sw/src*.

The first 3 words of the input of this IP represent:

 - the number of words read by the IP from the main memory;
 - the number of clock cycles the IP spend executing some dummy logic. This time includes the time spent in reading and writing the memory; and
 - the number of words written by the IP into the main memory;

This way, the actual input data starts form the 4th position of the input vector.

The IP uses an LFSR with 32 bits to mimmic some arbritary operation.
In this design, the LFSR seed is the sum of all *IN_MEM_SIZE* inputs. Next, the LFSR runs per *EXEC_CYCLES* iterations to generate a pseudo random value. Finally, the *OUT_MEM_SIZE* outputs are written with the value generated by the LFSR for each iteration.

## Resource Usage

The following report includes this IP and it considers the board PYNQ-Z1 (xc7z020clg400-1). 

|          Site Type         | Used | Fixed | Available | Util% |
|----------------------------|------|-------|-----------|-------|
| Slice LUTs*                | 1289 |     0 |     53200 |  2.42 |
|   LUT as Logic             | 1189 |     0 |     53200 |  2.23 |
|   LUT as Memory            |  100 |     0 |     17400 |  0.57 |
|     LUT as Distributed RAM |    0 |     0 |           |       |
|     LUT as Shift Register  |  100 |     0 |           |       |
| Slice Registers            | 2218 |     0 |    106400 |  2.08 |
|   Register as Flip Flop    | 2218 |     0 |    106400 |  2.08 |
|   Register as Latch        |    0 |     0 |    106400 |  0.00 |
| F7 Muxes                   |    0 |     0 |     26600 |  0.00 |
| F8 Muxes                   |    0 |     0 |     13300 |  0.00 |


|     Site Type     | Used | Fixed | Available | Util% |
|-------------------|------|-------|-----------|-------|
| Block RAM Tile    |    3 |     0 |       140 |  2.14 |
|   RAMB36/FIFO*    |    3 |     0 |       140 |  2.14 |
|     RAMB36E1 only |    3 |       |           |       |
|   RAMB18          |    0 |     0 |       280 |  0.00 |


## Test Software

When running the IP and its example self-checking software, the expected output is:

```
# ../synthetic 
starting prem 
fred_lib: connected to fred server!
buff: buffer mapped at addresses: 0x36ce2000, length:1048576 
buff: buffer mapped at addresses: 0x36f31000, length:32768 
in: 0x10
exec: 0x3A909909
out: 0xD2B93A90
Match!
Input Content [0:9]:
0       0x1
1       0x1
2       0x1
3       0x1
4       0x1

Expected Initial value at the output : 0x3A909909 
0       0x3A909909
1       0x9D484C84
2       0x4EA42642
3       0x27521321
4       0x93A90990

Output Content [0:9]:
0       0x3A909909
1       0x9D484C84
2       0x4EA42642
3       0x27521321
4       0x93A90990

Fred finished
Fred_BuffCtl: buffer deleted: id:7, size:1048576 
```


## Authors

- Alexandre Amory (July 2021), ReTiS Lab, Scuola Sant'Anna, Pisa, Italy. This HLS design.
- Francesco Restuccia (April 2021), ReTiS Lab, Scuola Sant'Anna, Pisa, Italy. Initial design in VHDL.
